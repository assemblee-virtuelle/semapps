<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-triplestore/webacl-implementation">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">ACL implementation in Jena Fuseki | SemApps</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://semapps.org/docs/triplestore/webacl-implementation"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="ACL implementation in Jena Fuseki | SemApps"><meta data-rh="true" name="description" content="Initial permissions mechanism"><meta data-rh="true" property="og:description" content="Initial permissions mechanism"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://semapps.org/docs/triplestore/webacl-implementation"><link data-rh="true" rel="alternate" href="https://semapps.org/docs/triplestore/webacl-implementation" hreflang="en"><link data-rh="true" rel="alternate" href="https://semapps.org/docs/triplestore/webacl-implementation" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="SemApps RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="SemApps Atom Feed"><link rel="stylesheet" href="/assets/css/styles.6810ed3e.css">
<link rel="preload" href="/assets/js/runtime~main.5d7fb354.js" as="script">
<link rel="preload" href="/assets/js/main.6814b9a8.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">SemApps</b></a><a class="navbar__item navbar__link" href="/team">Team</a><a class="navbar__item navbar__link" href="/docs/guides/ldp-server">Guides</a><a class="navbar__item navbar__link" href="/docs/middleware">Middleware</a><a class="navbar__item navbar__link" href="/docs/frontend">Frontend</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/triplestore">Triple Store</a><a class="navbar__item navbar__link" href="/docs/contribute/code">How to contribute</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/assemblee-virtuelle/semapps" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><main class="docMainContainer_gTbr docMainContainerEnhanced_Uz_u"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>ACL implementation in Jena Fuseki</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="initial-permissions-mechanism">Initial permissions mechanism<a class="hash-link" href="#initial-permissions-mechanism" title="Direct link to heading">​</a></h2><p>A class called <code>ShiroEvaluator</code> contains the logic of the permissions mechanism in Jena/Fuseki/Shiro</p><p>It is an implementation of <a href="https://jena.apache.org/documentation/permissions/" target="_blank" rel="noopener noreferrer">Jena permissions mechanism</a></p><p>Basically the HTTP SPARQL requests made on Jena endpoint should be Authenticated with the user admin, and a special header <code>X-SemappsUser</code> should contain a string representing the URI of the currently logged in user, or the value <code>system</code> if the query should bypass any ACL (the absence of such header is also considered as a <code>system</code> access level).</p><p>The <code>shiro.ini</code> file has been slightly modified in order to force Basic Authentication on all endpoints (it was previsouly too permissive)</p><p>The Jena storage backend is now TDB2 and the Jena version is 3.17 (latest as of february 2021).</p><p>The whole <code>localData</code> dataset is protected by the Jena permission mechanism that uses the class <code>ShiroEvaluator</code> to check ACLs.
See the configuration file in <code>configuration/localData.ttl</code> for more details.</p><p>To compile this class, please refer to <a href="https://github.com/assemblee-virtuelle/semapps/blob/master/src/jena/permissions/README.md" target="_blank" rel="noopener noreferrer">this README</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dataset-model-and-graph">Dataset, Model and Graph<a class="hash-link" href="#dataset-model-and-graph" title="Direct link to heading">​</a></h2><p>A short explanation on how the Dataset is configured and why.</p><p>See the file <code>src/jena/fuseki-docker/configuration/localData.ttl</code> to follow the names given here.</p><p>We will start from the top of the application stack: what the fuseki service exposes to the endpoints and web interface. In the localData file, we start to read from the end of the file and we go up.</p><ul><li>the fuseki service exposes a dataset called localData (and also another similar one called testData).</li><li>this <code>localData</code> dataset is called <code>securedDataset</code> in the config file. it is composed of 2 graphs :<ul><li>the <code>defaultGraph</code> which is accessible if no <code>GRAPH</code> keyword is used in the SPARQL.</li><li>a named graph called <code>&lt;http://semapps.org/webacl&gt;</code> which will contain all the webACL tuples.</li></ul></li><li>the fact that those 2 graphs are joined in the same <code>localData</code> dataset enables us to query on both graph in one request. This is specially useful when we will have to retrieve the list of users that belong to a group, if the group is outside of the scope of the webacl model (if it belongs to the application model, in the defaultGraph).</li></ul><p>Exemple of queries to access both graphs. <a href="https://jena.apache.org/tutorials/sparql_datasets.html" target="_blank" rel="noopener noreferrer">doc about Datasets in Jena here</a></p><ul><li>a query of the form <code>SELECT * { ?s ?p ?o }</code> will return only the results of the defaultGraph, without the ACL tuples, or any other named graph.</li><li>a query of the form <code>SELECT * FROM &lt;http://semapps.org/webacl&gt; { ?s ?p ?o }</code> will return all the ACL tuples, and only those. The ACL graph is behaving like it is the default graph in this case.</li><li>a query of the form <code>SELECT * { { ?s ?p ?o } UNION { GRAPH ?g { ?s ?p ?o } } }</code> will return the union of the 2 graphs. we can see that <code>g</code> gets a value only for the ACL tuples, as the defaultGraph has no graph name.</li><li>a query of the form <code>SELECT * { GRAPH ?g { ?s ?p ?o } }</code> will return only the ACL tuples because the default graph tuples do not have a graph name.</li><li>similarly <code>SELECT * { GRAPH &lt;http://semapps.org/webacl&gt; { ?s ?p ?o } }</code> will only return the ACL tuples.</li><li><code>SELECT * FROM NAMED &lt;http://semapps.org/webacl&gt; { ?s ?p ?o } }</code> will return nothing because it says we should use the named graph <code>webacl</code> WITHOUT importing it inside the default graph. The query does not mention that we should find tuples in named graphs, but instead, in the default graph. therefor the result is empty.</li><li>the correct way to use FROM NAMED is by specifying we want to search the named graphs : <code>SELECT * FROM NAMED &lt;http://semapps.org/webacl&gt; { GRAPH ?g { ?s ?p ?o } }</code></li></ul><p>We continue the explanation of the configuration file :</p><ul><li>each graph in our fuseki <code>localData</code> dataset is using a secured model to access the data. the defaultGraph uses <code>securedModel</code> and the ACL graph uses <code>securedACLModel</code>.</li><li>a model is just a wrapper on a graph, it adds few methods for list manipulations, essentially. So here we have a fuseki <code>Dataset</code> called <code>localData</code> that unites 2 logical graphs (one being the defaultGraph and the other being called <code>http://semapps.org/webacl</code>). Each logical graph is managed under the hood by a secured model. Each secured model is based on a plain TDB graph. Finally a TDB graph needs a storage definition, where the tuples eventually go into the harddisk. The storage is called DatasetTDB2 (not to be confused with the high level Dataset we talked about earlier).</li><li>The secured models get a name of their own, but this name is just used for internal things (and appears in the Java code of the evaluator), but you cannot query those graph names. the names of the 2  secured models are <code>http://semapps.org/securedModel</code> and <code>http://semapps.org/securedWebacl</code>. Each secured model is configured with a security evaluator which is the configuration for the instanciation of our <code>ShiroEvaluator</code> class. You can see that it gets 3 arguments when it is initialized. Those arguments are pointers to 2 graphs and one dataset used by the evaluator to make queries. The 2 graphs are the &quot;plain TDB graph&quot;, unprotected, that contain the tuples of the defaultGraph and of the ACL graph (the defaultGraph will probably not be used from the evaluator, but i pass it nevertheless). The dataset that is passed as 3rd argument is a special dataset that we build here only for the sake of passing it to the evaluator. It is an unprotected dataset that is the UNION of the 2 graphs (defaultGraph and ACL graph) so we can query the ACL tuples, together with the group tuples that are stored in the defaultGraph. This unprotected dataset is not exposed to the fuseki endpoints and cannot be queried from anywhere else.</li><li>finally we can see that the 2 plain TDB graphs that hold our tuples are stored in 2 separate locations on the disk. the tuples of the WebACL go to the database called <code>aclData</code> while the tuples of the defaultGraph go to the database <code>localData</code>. Initially I tried to have both graphs stored in the same database. When we remove the security layers (the secured models and their evaluators), Jena accepts to store the 2 graphs in the same database. But there is a bug related to the transaction that is not propagated down the chain of wrapping of models and graphs, and it breaks Jena. <a href="https://issues.apache.org/jira/browse/JENA-1492" target="_blank" rel="noopener noreferrer">this bug report sees to be of interest</a> but it concerns the use of a reasoner, not of a security evaluator. The bug has been fixed 2 years ago, but I suspect the wrapping of models and graphs in the SecuredAssembler is not done well, and the transaction is not forwarded down the line. <a href="https://stackoverflow.com/questions/35428064/reasoning-with-fuseki-tdb-and-named-graphs" target="_blank" rel="noopener noreferrer">Here is a SO post that confirms that several named graphs and a defaultGraph could all be stored on the same database/DatasetTDB</a>. But in our case, there is this problem of <code>TransactionException: Not in a transaction</code> ! So for the moment, the 2 graphs are stored in 2 separate databases.</li><li>please note that if you use additional named graphs in your system, they will be automatically created by Jena on the fly, and they will therefor be &quot;in memory&quot; graphs, hence, not persisted. Furthermore, they will not have any security or ACL enforcement mechanism. If you need to have some business related named graphs, you will have to add them in the localData.ttl configuration file, pretty much like the ACL graph has been added, and for the reason explained above, they will be stored in a separate database each. That does not prevent them from being accessed under the same <code>localData</code> endpoint !</li></ul><p>If the end-user adds some ACL tuples in the defaultGraph (via the sparql endpoint offered by the middleware, or as admin in the web interface of jena) then those ACL tuples will just be useless. We never use the defaultGraph to read out ACLs. This way, there is no way to inject malicious ACL tuples in our permission system.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="web-interface-for-sparql-queries">Web interface for SPARQL queries<a class="hash-link" href="#web-interface-for-sparql-queries" title="Direct link to heading">​</a></h2><p>Fuseki offers a web interface to query your dataset <a href="http://localhost:3030/dataset.html" target="_blank" rel="noopener noreferrer">here</a></p><p>This interface is protected by the <code>admin</code> user and password. If you expose this web interface to a public IP, the password should be stong and the http connection should be secured with a TLS certificate.</p><p>The <code>localData</code> dataset is accessible there as if are a <code>system</code> user, and all the tuples can be queried and modified, both on the defaultGraph and on the ACL named graph <code>http://semapps.org/webacl</code>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="web-acl">Web ACL<a class="hash-link" href="#web-acl" title="Direct link to heading">​</a></h2><p>The java class <code>ShiroEvaluator</code> is checking, for every SPARQL request, the subject of each tuple that the SPARQL engine has asked to receive from the underlying storage.
It also prevents a SemAppsUser from accessing the ACL graph.</p><p>Implementation of the <a href="https://github.com/solid/web-access-control-spec" target="_blank" rel="noopener noreferrer"> Web ACL specs</a> in Java.</p><p>We chose to implement the algorithm with a succession of small steps and SPARQL queries.
Indeed, at any moment, the algorithm can stop if it finds a matching permission. There is no need then to continue processing all the other cases, and we save some processing time.
Implementing a big and unique SPARQL query that would contain all the cases would be unrealistic, and not efficient.</p><p>Having a fine-grained set of small SPARQL queries is more efficient also because we can chose to which graph each part should query. Most of the queries are done on the webACL graph. We use the defaultGraph only in 2 occasions: to fetch the group members and the containers.</p><p>The algorithm proceeds like follow:</p><ul><li>checks permissions on the Ressource itself</li><li>checks permissions on the containers of that Ressource</li><li>checks permissions on all the parent containers in a recursive way.</li></ul><p>For each step, we have 2 cases:</p><ul><li>the user is anonymous, in which case we need to check for a <code>acl:AgentClass</code> with value <code>foaf:Agent</code></li><li>the user is a well known WEBID, in this case we need to check :<ul><li><code>acl:AgentClass</code> with value <code>foaf:Agent</code> (public access)</li><li><code>acl:AgentClass</code> with value <code>acl:AuthenticatedAgent</code> (all knwon registered users access)</li><li><code>acl:Agent</code> with the user&#x27;s webID</li><li><code>acl:agentGroup</code> with each of the groups the user belongs to (we retrieve the list separately, so we can reuse it later on, for the containers)</li></ul></li></ul><p>For the access Modes, here is the corresponding table between JENA access types and WebACL. <code>mode2</code> is an additional, complementary, optional mode that needs to be checked, in some cases.
JENA | WebACL mode1 | WebACL mode2
--- | --- | ---
Create | Append | Write
Read | Read | Write
Update | Write |
Delete | Write | </p><p>The evaluator stores in a cache the access control result that it finds for each ressource. The cache is used for subsequent evaluate calls within the same transaction/SPARQL request. Then the cache is emptied before the next query. </p><p>Blank nodes that are not part of a resource, meaning, orphan blanks nodes that linger at the root of the graph, can be created with Sparql, but cannot be retrieved afterwards. This is because the security mechanism cannot find the resource they belong to, and therefor, it denies access to it.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="tests">Tests<a class="hash-link" href="#tests" title="Direct link to heading">​</a></h2><p>Some unit tests have been setup up for the ACL mechanism. </p><p>In order for the test to work properly, you need to first load 2 files into Jena <code>testData</code> dataset:</p><ul><li>file <code>src/middleware/tests/fusekiAcl/testData.ttl</code></li><li>file <code>src/middleware/tests/fusekiAcl/ACL_test_data.ttl</code></li></ul><p>use this command in order to load the testData file:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token plain">$FUSEKI_HOME/tdbloader --loc=$FUSEKI_BASE/databases/testData testData.ttl</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>For the file <code>ACL_test_data.ttl</code> the easiest is to go to the web interface of fuseki, enter your the username admin and password, got to the dataset <code>testData</code> and enter the endpoint <code>/testData/update</code>. Then copy paste the content of the ACL_test_data.ttl into the textarea for the query, and press the play button.</p><p>To run the tests, go to <code>src/middleware/tests/</code>.
launch the command</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token plain">npm test -- --testPathPattern=src/middleware/tests/fusekiAcl</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>During the test, if you encounter problems with the running port of Fuseki or username and password, please change values in <code>src/middleware/tests/.env</code></p><p>TODO: test membership of groups that are in the defaultGraph (with inference of <code>rdfs:subPropertyOf vcard:hasMember</code>).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="code-guidelines">Code guidelines<a class="hash-link" href="#code-guidelines" title="Direct link to heading">​</a></h3><p>When coding in moleculer, it is important to always respect those rules:</p><ul><li>when calling the action directly from the same service <code>this.actions.nameOfAction(params)</code> it is important to add a second argument to pass the context <code>nameOfAction( params, { defaultCtx: ctx} );</code></li><li>when inside an action and calling another action (to another service), always use the form <code>ctx.call()</code> and not the form <code>this.broker.call()</code> as the later will lose the context.</li><li>when you need to make a <code>system</code> call to the triplestore, you have to explicitly state it in the call, by adding an option in the 3rd arguments (2nd if using this.actions)) <code>{ meta: { webId:&#x27;system&#x27; } }</code> like this: <code>ctx.call(&#x27;action.name&#x27;,{ param }, { meta: { webId:&#x27;system&#x27; } })</code></li><li>when programming an action in moleculer, if you want to offer the user a parameter called <code>webId</code> in your <code>ctx.params</code>, then becareful of 2 points:<ul><li>you don&#x27;t need to set this param <code>webId: ctx.meta.webId</code> when you call your action from the &quot;API action&quot;. Indeed, the webId will come automatically from the context meta.</li><li>in the moleculer action, you have to check if you received a webId from params, otherwise, use ctx.meta.webId. Something like <code>const webId = ctx.params.webId || ctx.meta.webId</code> and most importantly, in all your subsequent ctx.calls inside the action code, always pass this webId explicitly ! Or to other actions that take a webId in their params, or to actions that don&#x27;t take a webId in their params and in this case by using the meta in 3rd argument : <code>ctx.call(&#x27;an.action&#x27;,{...myparams},{ meta: { webId} });</code>.</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="example-of-usage">Example of usage<a class="hash-link" href="#example-of-usage" title="Direct link to heading">​</a></h2><p>The user <code>https://data.virtual-assembly.org/users/sebastien.rosset</code> is member of the group <code>http://localhost:3000/_groups/group4</code>.</p><p>The resource <code>http://localhost:3000/organizations/cheznous</code> is located, among others, in the container <code>http://localhost:3000/container28/</code> which itself is inside the parent container <code>http://localhost:3000/container29/</code>.</p><p>Because the <code>group4</code> has been granted <code>Read</code> permission to the <code>container29</code>, and because the user <code>sebastien.rosset</code> has been granted an individual <code>Write</code> permission on the resource <code>organizations/cheznous</code>, the following reply is given to this API call for this resource :</p><p>In Turtle:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token plain">@prefix acl: &lt;http://www.w3.org/ns/auth/acl#&gt;.</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">@prefix foaf: &lt;http://xmlns.com/foaf/0.1/&gt;.</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">@prefix : &lt;http://localhost:3000/_acl/organizations/cheznous#&gt;.</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">:Write a acl:Authorization;</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    acl:accessTo &lt;http://localhost:3000/organizations/cheznous&gt;;</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    acl:mode acl:Write;</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    acl:agent &lt;https://data.virtual-assembly.org/users/sebastien.rosset&gt;.</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">&lt;http://localhost:3000/_acl/container29#DefaultRead&gt; a acl:Authorization;</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    acl:mode acl:Read;</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    acl:default &lt;http://localhost:3000/container29&gt;;</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    acl:agentGroup &lt;http://localhost:3000/_groups/group4&gt;.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In JSON-LD:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token plain">{</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    &quot;@context&quot;: {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        &quot;acl&quot;: &quot;http://www.w3.org/ns/auth/acl#&quot;,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        &quot;foaf&quot;: &quot;http://xmlns.com/foaf/0.1/&quot;,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        &quot;@base&quot;: &quot;http://localhost:3000/_acl/organizations/cheznous&quot;</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    &quot;@graph&quot;: [</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            &quot;@id&quot;: &quot;#Write&quot;,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            &quot;@type&quot;: &quot;acl:Authorization&quot;,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            &quot;acl:accessTo&quot;: &quot;http://localhost:3000/organizations/cheznous&quot;,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            &quot;acl:agent&quot;: &quot;https://data.virtual-assembly.org/users/sebastien.rosset&quot;,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            &quot;acl:mode&quot;: &quot;acl:Write&quot;</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            &quot;@id&quot;: &quot;http://localhost:3000/_acl/container29/#DefaultRead&quot;,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            &quot;@type&quot;: &quot;acl:Authorization&quot;,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            &quot;acl:agentGroup&quot;: &quot;http://localhost:3000/_groups/group4&quot;,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            &quot;acl:default&quot;: &quot;http://localhost:3000/container29&quot;,</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">            &quot;acl:mode&quot;: &quot;acl:Read&quot;</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Furthermore, it happens that the same user has <code>Control</code> permission on the <code>container29</code>, if we ask for the permissions on that container, this is what we will get:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token plain">@prefix acl: &lt;http://www.w3.org/ns/auth/acl#&gt;.</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">@prefix foaf: &lt;http://xmlns.com/foaf/0.1/&gt;.</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">@prefix : &lt;http://localhost:3000/_acl/container29#&gt;.</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">:Control a acl:Authorization;</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    acl:accessTo &lt;http://localhost:3000/container29&gt;;</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    acl:mode acl:Control;</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    acl:agent &lt;https://data.virtual-assembly.org/users/sebastien.rosset&gt;.</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">:DefaultRead a acl:Authorization;</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    acl:mode acl:Read;</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    acl:agentGroup &lt;http://localhost:3000/_groups/group4&gt;;</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">    acl:default &lt;http://localhost:3000/container29&gt;.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="security">Security<a class="hash-link" href="#security" title="Direct link to heading">​</a></h2><p>In general it is possible to obtain the list of all resource inside a container, if the user has Read access to the container, and even if they have no accesss to the resources themselves. </p><p>The LDP API will not show those resources though, because of the way it is implemented internally. But a SPARQL query on the apraql public endpoint will return them. It will return only the URIs of those resources. But this could still be considered a leak of some information.</p><p>The only way to eal with this problem is to uncomment line <a href="https://github.com/assemblee-virtuelle/semapps/blob/e67f545faf55f3a6343012ab8b74878e14a7ba4c/src/jena/permissions/src/main/java/org/semapps/jena/permissions/ShiroEvaluator.java#L602" target="_blank" rel="noopener noreferrer">602 of shiroEvaluator</a> so it will check also the permissions of the Object of every triple, which we do not do for now, for performances reasons, and for compliance with the LDP protocol which deal with resources as a unit of data and ACL.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="future">Future<a class="hash-link" href="#future" title="Direct link to heading">​</a></h2><ul><li><p>If one day you program an action to delete a user profile, after deleting the user resource, please also call the <code>removeAgentGroupOrAgentFromAuthorizations</code> method, with a isGroup=false parameter.</p></li><li><p>When creation of arbitrary containers at the root will be possible, please prevent the user from chosing those slugs, that must be reserved for system paths :</p></li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9EFEFF;--prism-background-color:#2D2A55"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9EFEFF"><span class="token plain">/_acl</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">/_groups</span><br></span><span class="token-line" style="color:#9EFEFF"><span class="token plain">/_rights</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>For perfs improvement, switch the code of ShiroEvaluator to use the Java API for querying the model, instead of SPARQL queries.</p></li><li><p>root container <a href="https://github.com/assemblee-virtuelle/semapps/issues/429" target="_blank" rel="noopener noreferrer">https://github.com/assemblee-virtuelle/semapps/issues/429</a></p></li><li><p>PATCH of a resource : do the DELETE and INSERT in one call/transaction.</p></li><li><p>default perms for containers as a parameter in the code?</p></li><li><p>create a system named graph to store semapps config as triples. should be protected as webacl graph (no access except by system)</p></li><li><p>inference and groups defined in the business data model : <a href="https://github.com/assemblee-virtuelle/semapps/issues/590" target="_blank" rel="noopener noreferrer">https://github.com/assemblee-virtuelle/semapps/issues/590</a>
in this case, how to call <code>removeAgentGroupOrAgentFromAuthorizations</code> when a group is deleted ? listen to some message ? need to configure which resource type should be listened to (Organization, Role...).</p></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/assemblee-virtuelle/semapps/edit/master/website/docs/triplestore/webacl-implementation.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#initial-permissions-mechanism" class="table-of-contents__link toc-highlight">Initial permissions mechanism</a></li><li><a href="#dataset-model-and-graph" class="table-of-contents__link toc-highlight">Dataset, Model and Graph</a></li><li><a href="#web-interface-for-sparql-queries" class="table-of-contents__link toc-highlight">Web interface for SPARQL queries</a></li><li><a href="#web-acl" class="table-of-contents__link toc-highlight">Web ACL</a></li><li><a href="#tests" class="table-of-contents__link toc-highlight">Tests</a><ul><li><a href="#code-guidelines" class="table-of-contents__link toc-highlight">Code guidelines</a></li></ul></li><li><a href="#example-of-usage" class="table-of-contents__link toc-highlight">Example of usage</a></li><li><a href="#security" class="table-of-contents__link toc-highlight">Security</a></li><li><a href="#future" class="table-of-contents__link toc-highlight">Future</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Guides</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/guides/ldp-server">Create your first LDP server</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/guides/dms">Add a Data Management System</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/guides/activitypub">Create an ActivityPub server</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://forums.assemblee-virtuelle.org/c/projets/semapps/11" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discourse (French)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://chat.lescommuns.org/channel/semapps_dev" target="_blank" rel="noopener noreferrer" class="footer__link-item">Chatroom<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://chat.lescommuns.org/channel/Semapps_accueil" target="_blank" rel="noopener noreferrer" class="footer__link-item">Contact<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/assemblee-virtuelle/semapps" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Virtual Assembly</div></div></div></footer></div>
<script src="/assets/js/runtime~main.5d7fb354.js"></script>
<script src="/assets/js/main.6814b9a8.js"></script>
</body>
</html>