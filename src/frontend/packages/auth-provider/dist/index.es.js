import e,{createElement as t,cloneElement as n,forwardRef as r,useState as o,useEffect as a,useCallback as i}from"react";import{TopToolbar as c,ListButton as l,ShowButton as u,Toolbar as s,SaveButton as m,DeleteButton as f,usePermissionsOptimized as d,Edit as p,useNotify as h,useLogin as g,Notification as y,useLogout as b,Resource as v,useDataProvider as E,Loading as w,Error as k,useAuthProvider as C,Button as P,EditButton as I,Show as O,MenuItemLink as j,useGetIdentity as x,UserMenu as A}from"react-admin";import{makeStyles as S,Card as N,Avatar as U,CardActions as T,Button as R,ListItem as L,ListItemAvatar as W,ListItemText as D,ListItemSecondaryAction as $,IconButton as M,Menu as F,MenuItem as B,ListItemIcon as G,List as V,Dialog as H,DialogTitle as J,DialogContent as z,TextField as _,DialogActions as q}from"@material-ui/core";import K from"@material-ui/icons/Public";import Q from"@material-ui/icons/VpnLock";import X from"@material-ui/icons/Person";import Y from"@material-ui/icons/Group";import{ThemeProvider as Z}from"@material-ui/styles";import{makeStyles as ee,createMuiTheme as te}from"@material-ui/core/styles";import ne from"@material-ui/icons/Lock";import re from"@material-ui/core/MenuItem";import oe from"@material-ui/icons/PowerSettingsNew";import ae from"@material-ui/icons/Share";import ie from"@material-ui/icons/Edit";import ce from"@material-ui/icons/Check";import le from"@material-ui/icons/AccountCircle";function ue(e,t,n,r,o,a,i){try{var c=e[a](i),l=c.value}catch(e){return void n(e)}c.done?t(l):Promise.resolve(l).then(r,o)}function se(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){ue(a,r,o,i,c,"next",e)}function c(e){ue(a,r,o,i,c,"throw",e)}i(void 0)}))}}function me(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function fe(){return(fe=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function de(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function pe(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?de(Object(n),!0).forEach((function(t){me(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):de(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function he(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}function ge(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var n=[],r=!0,o=!1,a=void 0;try{for(var i,c=e[Symbol.iterator]();!(r=(i=c.next()).done)&&(n.push(i.value),!t||n.length!==t);r=!0);}catch(e){o=!0,a=e}finally{try{r||null==c.return||c.return()}finally{if(o)throw a}}return n}(e,t)||ye(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ye(e,t){if(e){if("string"==typeof e)return be(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?be(e,t):void 0}}function be(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function ve(e){this.message=e}ve.prototype=new Error,ve.prototype.name="InvalidCharacterError";var Ee="undefined"!=typeof window&&window.atob&&window.atob.bind(window)||function(e){var t=String(e).replace(/=+$/,"");if(t.length%4==1)throw new ve("'atob' failed: The string to be decoded is not correctly encoded.");for(var n,r,o=0,a=0,i="";r=t.charAt(a++);~r&&(n=o%4?64*n+r:r,o++%4)?i+=String.fromCharCode(255&n>>(-2*o&6)):0)r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(r);return i};function we(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}try{return function(e){return decodeURIComponent(Ee(e).replace(/(.)/g,(function(e,t){var n=t.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n})))}(t)}catch(e){return Ee(t)}}function ke(e){this.message=e}ke.prototype=new Error,ke.prototype.name="InvalidTokenError";var Ce="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var Pe,Ie=function(e,t){return e(t={exports:{}},t.exports),t.exports}((function(e){var t,n;t=Ce,n=function(){function e(e){var t=[];if(0===e.length)return"";if("string"!=typeof e[0])throw new TypeError("Url must be a string. Received "+e[0]);if(e[0].match(/^[^/:]+:\/*$/)&&e.length>1){var n=e.shift();e[0]=n+e[0]}e[0].match(/^file:\/\/\//)?e[0]=e[0].replace(/^([^/:]+):\/*/,"$1:///"):e[0]=e[0].replace(/^([^/:]+):\/*/,"$1://");for(var r=0;r<e.length;r++){var o=e[r];if("string"!=typeof o)throw new TypeError("Url must be a string. Received "+o);""!==o&&(r>0&&(o=o.replace(/^[\/]+/,"")),o=r<e.length-1?o.replace(/[\/]+$/,""):o.replace(/[\/]+$/,"/"),t.push(o))}var a=t.join("/"),i=(a=a.replace(/\/(\?|&|#[^!])/g,"$1")).split("?");return a=i.shift()+(i.length>0?"?":"")+i.join("&")}return function(){return e("object"==typeof arguments[0]?arguments[0]:[].slice.call(arguments))}},e.exports?e.exports=n():t.urljoin=n()})),Oe=function(e,t){return Ie(e,t.replace(e,"_acl/"))},je=function(e){var t,n,r=e.middlewareUri,o=e.httpClient,a=e.checkPermissions,i=e.resources;return{login:function(e){return window.location.href="".concat(r,"auth?redirectUrl=")+encodeURIComponent(window.location.href),Promise.resolve()},logout:function(){var e=new URL(window.location.href);return window.location.href="".concat(r,"auth/logout?redirectUrl=")+encodeURIComponent(e.origin+"/login?logout"),Promise.resolve("/")},checkAuth:function(){return localStorage.getItem("token"),Promise.resolve()},checkError:function(e){return Promise.resolve()},getPermissions:(n=se(regeneratorRuntime.mark((function e(t){var n,c,l,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a){e.next=2;break}return e.abrupt("return",!0);case 2:return n=i[t]?i[t].containerUri:t,c=Oe(r,n),e.next=6,o(c);case 6:return l=e.sent,u=l.json,e.abrupt("return",u["@graph"]);case 9:case"end":return e.stop()}}),e)}))),function(e){return n.apply(this,arguments)}),addPermission:(t=se(regeneratorRuntime.mark((function e(t,n,a,c){var l,u,s,m;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:l=i[t]?i[t].containerUri:t,u=Oe(r,l),s={"@id":u+"#"+c.replace("acl:",""),"@type":"acl:Authorization","acl:accessTo":l,"acl:mode":c},e.t0=a,e.next="user"===e.t0?6:"group"===e.t0?8:"anon"===e.t0||"anyUser"===e.t0?10:12;break;case 6:return s["acl:agent"]=n,e.abrupt("break",13);case 8:return s["acl:agentGroup"]=n,e.abrupt("break",13);case 10:return s["acl:agentClass"]=n,e.abrupt("break",13);case 12:throw new Error("Unknown agent type: "+a);case 13:return e.next=15,o(u,{method:"PATCH",body:JSON.stringify({"@context":{acl:"http://www.w3.org/ns/auth/acl#",foaf:"http://xmlns.com/foaf/0.1/"},"@graph":[s]})});case 15:return m=e.sent,e.abrupt("return",204===m.status);case 17:case"end":return e.stop()}}),e)}))),function(e,n,r,o){return t.apply(this,arguments)}),getIdentity:function(){var e=localStorage.getItem("token");if(e){var t=function(e,t){if("string"!=typeof e)throw new ke("Invalid token specified");var n=!0===(t=t||{}).header?0:1;try{return JSON.parse(we(e.split(".")[n]))}catch(e){throw new ke("Invalid token specified: "+e.message)}}(e);return{id:t.webId,fullName:t.name}}}}},xe=function(t){var n=t.basePath,r=t.className,o=t.data,a=t.hasList,i=t.hasShow,s=he(t,["basePath","className","data","hasList","hasShow"]);return e.createElement(c,fe({className:r},s),a&&e.createElement(l,{basePath:n,record:o}),i&&e.createElement(u,{basePath:n,record:o}))},Ae=S((function(){return{toolbar:{flex:1,display:"flex",justifyContent:"space-between"}}})),Se=function(t){var n=t.hasDelete,r=he(t,["hasDelete"]),o=Ae();return e.createElement(s,fe({},r,{className:o.toolbar}),e.createElement(m,null),n&&e.createElement(f,{undoable:!1}))},Ne=["acl:Read","acl:Append","acl:Write","acl:Control"],Ue=["acl:Append","acl:Write","acl:Control"],Te=["acl:Append","acl:Write","acl:Control"],Re=["acl:Write","acl:Control"],Le=["acl:Control"],We=(me(Pe={},"acl:Read","Lire"),me(Pe,"acl:Append","Enrichir"),me(Pe,"acl:Write","Modifier"),me(Pe,"acl:Control","Administrer"),Pe),De={anon:{label:"Tous les utilisateurs",icon:e.createElement(K,null)},anyUser:{label:"Utilisateurs connectés",icon:e.createElement(Q,null)},user:{icon:e.createElement(X,null)},group:{icon:e.createElement(Y,null)}},$e=function(t){var n=d(t.id).permissions;return e.createElement(p,fe({actions:e.createElement(xe,null)},t,{permissions:n}),e.cloneElement(t.children,{toolbar:e.createElement(Se,{hasDelete:n&&n.some((function(e){return Re.includes(e["acl:mode"])}))})}))},Me=ee((function(e){return{main:{display:"flex",flexDirection:"column",minHeight:"100vh",alignItems:"center",justifyContent:"flex-start",backgroundColor:e.palette.primary[500]},card:{minWidth:300,marginTop:"6em"},lockIconAvatar:{margin:"1em",display:"flex",justifyContent:"center"},lockIcon:{backgroundColor:e.palette.secondary[500]}}})),Fe=function(e){var r=e.theme,o=e.history,a=e.location,i=e.buttons,c=Me(),l=h(),u=g(),s=new URLSearchParams(a.search);return s.has("token")&&(localStorage.setItem("token",s.get("token")),l("Vous êtes maintenant connecté","info"),o.push("/")),s.has("logout")&&(localStorage.removeItem("token"),l("Vous êtes maintenant déconnecté","info"),o.push("/")),t(Z,{theme:te(r)},t("div",{className:c.main},t(N,{className:c.card},t("div",{className:c.lockIconAvatar},t(U,{className:c.lockIcon},t(ne,null))),i&&i.map((function(e){return t(T,null,n(e,{fullWidth:!0,variant:"outlined",type:"submit",onClick:function(){return u({},"/login")}}))})))),t(y,null))};Fe.defaultProps={buttons:[t(R,{startIcon:t(U,{src:"/lescommuns.jpg"})},"Les Communs")]};var Be=r((function(t,n){var r=b();return e.createElement(re,{onClick:function(){return r()},ref:n},e.createElement(oe,null),"   Se déconnecter")})),Ge=function(t){var n=t.name,r=t.list,o=t.create,a=he(t,["name","list","create"]),i=d(n).permissions;return e.createElement(v,fe({},a,{name:n,list:i&&i.some((function(e){return Ne.includes(e["acl:mode"])}))?r:void 0,create:i&&i.some((function(e){return Ue.includes(e["acl:mode"])}))?o:void 0}))},Ve=S((function(){return{listItem:{paddingLeft:4,paddingRight:36},secondaryText:{textAlign:"center",width:"50%",fontStyle:"italic",color:"grey"}}})),He=function(t){var n=t.agent,r=t.addPermission,i=Ve(),c=E(),l=ge(e.useState(null),2),u=l[0],s=l[1],m=ge(o(),2),f=m[0],d=m[1],p=ge(o(!0),2),h=p[0],g=p[1],y=ge(o(),2),b=y[0],v=y[1];if(a((function(){"user"===n.type?c.getOne("Person",{id:n.id}).then((function(e){var t=e.data;d(t),g(!1)})).catch((function(e){v(e),g(!1)})):g(!1)}),[n.id,n.type]),"group"===n.type)return null;var C=function(){return s(null)};return h?e.createElement(w,null):b?e.createElement(k,null):e.createElement(L,{button:!0,className:i.listItem},e.createElement(W,null,e.createElement(U,{src:null==f?void 0:f.image},n.icon)),e.createElement(D,{primary:n.label||(null==f?void 0:f.name)}),e.createElement(D,{className:i.secondaryText,primary:n.permissions&&n.permissions.map((function(e){return We[e]})).join(", ")}),e.createElement($,null,e.createElement(M,{onClick:function(e){return s(e.currentTarget)}},e.createElement(ie,null)),e.createElement(F,{anchorEl:u,keepMounted:!0,open:Boolean(u),onClose:C},Object.entries(We).map((function(t){var o=ge(t,2),a=o[0],i=o[1];return e.createElement(B,{onClick:function(){r(n.id,n.type,a),C()}},e.createElement(G,null,n.permissions&&n.permissions.includes(a)?e.createElement(ce,null):null),e.createElement(D,{primary:i}))})))))},Je=S((function(e){return{list:{width:"100%",maxWidth:"100%",backgroundColor:e.palette.background.paper}}})),ze=function(e){return e?Array.isArray(e)?e:[e]:void 0},_e=function(e,t){return Array.isArray(e["acl:agentClass"])?e["acl:agentClass"].includes(t):e["acl:agentClass"]===t},qe=function(e,t,n,r){e[t]?e[t].permissions.push(r):e[t]=pe(pe({id:t,type:n},De[n]),{},{permissions:[r]})},Ke=function(t){var n=t.record,r=Je(),c=ge(o({}),2),l=c[0],u=c[1],s=d(n.id).permissions,m=C();a((function(){var e,t={},n=function(e){if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(e=ye(e))){var t=0,n=function(){};return{s:n,n:function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,o,a=!0,i=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return a=e.done,e},e:function(e){i=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(i)throw o}}}}(s);try{var r=function(){var n=e.value;_e(n,"foaf:Agent")&&qe(t,"foaf:Agent","anon",n["acl:mode"]),_e(n,"acl:AuthenticatedAgent")&&qe(t,"acl:AuthenticatedAgent","anyUser",n["acl:mode"]),n["acl:agent"]&&ze(n["acl:agent"]).forEach((function(e){return qe(t,e,"user",n["acl:mode"])})),n["acl:agentGroup"]&&ze(n["acl:agentGroup"]).forEach((function(e){return qe(t,e,"group",n["acl:mode"])}))};for(n.s();!(e=n.n()).done;)r()}catch(e){n.e(e)}finally{n.f()}u(t)}),[s]);var f=i((function(e,t,r){m.addPermission(n.id,e,t,r).then((function(e){}))}),[l]);return e.createElement(V,{dense:!0,className:r.list},Object.entries(l).map((function(t){var n=ge(t,2),r=n[0],o=n[1];return e.createElement(He,{key:r,agent:o,addPermission:f})})))},Qe=S((function(){return{title:{paddingBottom:8},actions:{padding:15},addForm:{paddingTop:0},listForm:{paddingTop:0,paddingBottom:0,paddingRight:0,maxHeight:200}}})),Xe=function(t){var n=t.record,r=Qe(),a=ge(o(!1),2),i=a[0],c=a[1];return e.createElement(e.Fragment,null,e.createElement(P,{label:"Permissions",onClick:function(){return c(!0)}},e.createElement(ae,null)),e.createElement(H,{fullWidth:!0,open:i,onClose:function(){return c(!1)}},e.createElement(J,{className:r.title},"Permissions sur la ressource"),e.createElement(z,{className:r.addForm},e.createElement(_,{label:"Ajouter un utilisateur ou un groupe...",variant:"filled",margin:"dense",fullWidth:!0})),e.createElement(z,{className:r.listForm},e.createElement(Ke,{record:n})),e.createElement(q,{className:r.actions},e.createElement(P,{label:"ra.action.close",variant:"inlined",onClick:function(){return c(!1)}}))))},Ye=function(t){var n=t.basePath,r=t.className,o=t.data,a=t.hasList,i=t.hasEdit,u=t.hasControl,s=he(t,["basePath","className","data","hasList","hasEdit","hasControl"]);return e.createElement(c,fe({className:r},s),a&&e.createElement(l,{basePath:n,record:o}),i&&e.createElement(I,{basePath:n,record:o}),u&&e.createElement(Xe,{basePath:n,record:o}))},Ze=function(t){var n=d(t.id).permissions;return e.createElement(O,fe({actions:e.createElement(Ye,{hasControl:n&&n.some((function(e){return Le.includes(e["acl:mode"])}))})},t,{permissions:n,hasEdit:n&&n.some((function(e){return Te.includes(e["acl:mode"])}))}))},et=r((function(t,n){var r=t.onClick,o=t.webId;return e.createElement(j,{ref:n,to:"/Person/".concat(encodeURIComponent(o),"/show"),primaryText:"Voir mon profil",leftIcon:e.createElement(le,null),onClick:r})})),tt=r((function(t,n){var r=t.onClick,o=t.webId;return e.createElement(j,{ref:n,to:"/Person/".concat(encodeURIComponent(o),"/edit"),primaryText:"Editer mon profil",leftIcon:e.createElement(ie,null),onClick:r})})),nt=r((function(t,n){var r=t.onClick;return e.createElement(j,{ref:n,to:"/login",primaryText:"Se connecter",onClick:r})})),rt=function(t){var n=t.logout,r=he(t,["logout"]),o=x().identity;return e.createElement(A,r,o&&""!==o.id?[e.createElement(et,{webId:o.id,key:"view"}),e.createElement(tt,{webId:o.id,key:"edit"}),e.cloneElement(n,{key:"logout"})]:e.createElement(nt,null))};export{xe as EditActions,$e as EditWithPermissions,Fe as LoginPage,Be as LogoutButton,Ge as ResourceWithPermissions,Ye as ShowActions,Ze as ShowWithPermissions,rt as UserMenu,je as authProvider};
